### 2.1 n8nの基本概念

n8nは、ノーコードでワークフロー自動化を実現するオープンソースのプラットフォームであり、コンセンサスモデルのような複雑なシステムを効率的に実装するための強力な基盤を提供します。n8nの基本概念を理解することは、コンセンサスモデルの実装において不可欠です。

**ワークフロー（Workflow）の概念と役割**

ワークフローは、n8nにおける最も基本的な構成単位であり、一連の処理フローを表現するものです。コンセンサスモデルの実装では、各コンポーネント（データ収集、分析、評価、統合、出力、管理）がそれぞれ独立したワークフローとして設計され、それらが連携して全体のシステムを形成します。

ワークフローは単なる処理の流れ図ではなく、実行可能なビジネスロジックの集合体です。各ワークフローは、特定のビジネス目標（例：テクノロジー視点のデータ分析、視点間の整合性評価など）を達成するために設計され、必要に応じて他のワークフローと連携します。この設計アプローチにより、システム全体の複雑さを管理しやすい単位に分割し、開発・保守・拡張を容易にすることができます。

コンセンサスモデルでは、例えば「テクノロジー視点データ収集ワークフロー」「マーケット視点分析ワークフロー」「視点統合ワークフロー」など、機能ごとに特化したワークフローを作成し、それらを連携させることで全体のプロセスを実現します。

**ノード（Node）の概念と種類**

ノードは、ワークフロー内の個別の処理単位であり、特定の機能を担当して入力を受け取り出力を生成します。n8nには200以上の組み込みノードが用意されており、これらを組み合わせることで複雑な処理を実現できます。

コンセンサスモデルの実装で特に重要なノードには以下のようなものがあります：

- **HTTP Requestノード**: 外部APIやWebサービスとの連携に使用します。テクノロジー視点のデータ収集や、外部分析サービスの利用などに不可欠です。このノードは、RESTful APIやGraphQL APIなど様々なプロトコルをサポートし、認証機能も備えているため、セキュアな連携が可能です。

- **Functionノード**: JavaScriptコードを実行して、カスタムロジックを実装します。変化点検出アルゴリズム、重要度計算、整合性評価など、コンセンサスモデルの核心的な処理はこのノードで実装されることが多いです。複雑な数学的計算や条件分岐も柔軟に記述できます。

- **Splitノード/Mergeノード**: データフローの分岐と統合を制御します。複数の視点からのデータを並列処理し、後で結果を統合する際に重要な役割を果たします。特に、視点統合プロセスでは、これらのノードを活用して効率的なデータフロー制御を実現します。

- **Ifノード**: 条件分岐を実現します。データの特性や処理結果に応じて、異なる処理パスを選択する際に使用します。例えば、重要度スコアが特定の閾値を超えた場合にのみ、詳細分析を実行するといった制御が可能です。

- **Webhookノード**: 外部システムからのイベント通知を受け取ります。リアルタイム性が求められるシナリオ（例：市場データの急激な変化を検知した場合の即時分析）で重要な役割を果たします。

- **Databaseノード**: データベースとの連携を実現します。分析結果の永続化や、過去のデータとの比較分析などに使用します。様々なデータベース（MySQL、PostgreSQL、MongoDB等）と接続可能です。

これらのノードは単独でも強力ですが、組み合わせることでさらに複雑な処理を実現できます。例えば、HTTP Requestノードでデータを取得し、Functionノードで前処理を行い、Databaseノードで保存するという一連の流れを作成できます。

**トリガー（Trigger）の概念と活用方法**

トリガーは、ワークフローの実行を開始するきっかけとなるノードです。コンセンサスモデルの実装では、様々なトリガーを活用して、適切なタイミングでワークフローを起動します。

主要なトリガータイプとその活用方法は以下の通りです：

- **スケジュールトリガー**: 定期的にワークフローを実行します。例えば、毎日特定の時間にデータ収集ワークフローを起動し、最新情報を取得するといった用途に適しています。cron式を使用して複雑なスケジュールも設定可能です。

- **Webhookトリガー**: 外部システムからのHTTPリクエストをトリガーとします。例えば、新しいデータが利用可能になった時点で分析ワークフローを起動するといった、イベント駆動型のシナリオに適しています。

- **ワークフロートリガー**: 他のワークフローの完了をトリガーとします。例えば、すべての視点の分析ワークフローが完了した時点で、統合ワークフローを起動するといった連携が可能です。

- **エラートリガー**: エラー発生時に特定のワークフローを起動します。例えば、データ収集中にエラーが発生した場合、代替データソースからの収集を試みるリカバリーワークフローを起動するといった用途に適しています。

コンセンサスモデルでは、これらのトリガーを組み合わせることで、定期的な分析サイクルとイベント駆動型の即時分析の両方を実現できます。例えば、基本的には毎日定時にデータ収集と分析を行いつつ、重要なマーケットイベントが発生した場合には即時に追加分析を実行するといった柔軟な運用が可能です。

**接続（Connection）の概念と設計**

接続は、ノード間のデータの流れを表現するものであり、ワークフローの構造を定義する重要な要素です。n8nでは、ノード間の接続を通じてデータが変換・加工されながら流れていきます。

コンセンサスモデルの実装における接続の設計ポイントは以下の通りです：

- **データマッピング**: 出力ノードから入力ノードへのデータマッピングを適切に設定することで、必要なデータ項目だけを次のノードに渡すことができます。これにより、処理効率の向上とデータの整理が実現できます。

- **条件付き接続**: 特定の条件を満たす場合にのみデータを次のノードに渡す設定が可能です。例えば、重要度スコアが閾値を超えるデータのみを詳細分析ノードに渡すといった制御ができます。

- **エラーハンドリング接続**: 処理エラー時の代替パスを設定できます。これにより、一部のデータ処理に失敗しても、全体のワークフローが停止することなく、適切なエラー処理や代替処理を実行できます。

- **並列・直列接続の組み合わせ**: 処理の性質に応じて、並列接続（複数のノードが同時に処理を実行）と直列接続（前のノードの処理完了後に次のノードが実行）を適切に組み合わせることで、処理効率と論理的整合性のバランスを取ることができます。

コンセンサスモデルでは、例えば3つの視点（テクノロジー、マーケット、ビジネス）の分析を並列に実行し、その結果を統合ノードで集約するといった接続パターンが頻繁に使用されます。また、データの前処理、主処理、後処理といった一連の流れを直列接続で表現することも一般的です。

これらの基本概念（ワークフロー、ノード、トリガー、接続）を理解し適切に組み合わせることで、コンセンサスモデルのような複雑なシステムもn8n上で効率的に実装することができます。n8nの視覚的なインターフェースを活用すれば、技術的な詳細を抽象化しつつ、ビジネスロジックに集中した開発が可能になります。
